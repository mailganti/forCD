<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orchestration Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .log-entry { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Orchestration Dashboard</h1>
                        <p class="text-sm text-gray-500 mt-1">Workflow & Agent Management</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="app.loadData()" class="btn-primary">
                            ðŸ”„ Refresh
                        </button>
                        <button onclick="app.logout()" class="btn-secondary">
                            ðŸšª Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Tabs -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-8">
                    <button onclick="app.setTab('workflows')" class="tab-btn" data-tab="workflows">
                        Workflows
                    </button>
                    <button onclick="app.setTab('agents')" class="tab-btn" data-tab="agents">
                        Agents
                    </button>
                    <button onclick="app.setTab('scripts')" class="tab-btn" data-tab="scripts">
                        Scripts
                    </button>
                </nav>
            </div>

            <!-- Workflows Tab -->
            <div id="workflows-tab" class="tab-content">
                <div class="bg-white shadow-sm rounded-lg overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Workflows</h2>
                    </div>
                    <div id="workflows-list"></div>
                </div>
            </div>

            <!-- Agents Tab -->
            <div id="agents-tab" class="tab-content hidden">
                <div class="bg-white shadow-sm rounded-lg overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Agents</h2>
                    </div>
                    <div id="agents-list"></div>
                </div>
            </div>

            <!-- Scripts Tab -->
            <div id="scripts-tab" class="tab-content hidden">
                <div class="bg-white shadow-sm rounded-lg overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Scripts</h2>
                    </div>
                    <div id="scripts-list"></div>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="mt-6 bg-white shadow-sm rounded-lg overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">Activity Log</h2>
                </div>
                <div class="px-6 py-4 max-h-64 overflow-y-auto" id="activity-log">
                    <p class="text-sm text-gray-500">No activity yet</p>
                </div>
            </div>
        </div>
    </div>

    <style>
        .btn-primary {
            @apply inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500;
        }
        .btn-secondary {
            @apply inline-flex items-center px-4 py-2 border border-red-300 rounded-md shadow-sm text-sm font-medium text-red-700 bg-white hover:bg-red-50;
        }
        .btn-execute {
            @apply inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500;
        }
        .tab-btn {
            @apply whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm capitalize border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300;
        }
        .tab-btn.active {
            @apply border-blue-500 text-blue-600;
        }
        .badge {
            @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium;
        }
        .badge-green { @apply bg-green-100 text-green-800; }
        .badge-yellow { @apply bg-yellow-100 text-yellow-800; }
        .badge-blue { @apply bg-blue-100 text-blue-800; }
        .badge-red { @apply bg-red-100 text-red-800; }
        .badge-gray { @apply bg-gray-100 text-gray-800; }
    </style>

    <script>
        const app = {
            activeTab: 'workflows',
            workflows: [],
            agents: [],
            scripts: [],
            executions: {},

            async apiCall(endpoint, options = {}) {
                try {
                    const response = await fetch(`/api${endpoint}`, {
                        ...options,
                        headers: {
                            'Content-Type': 'application/json',
                            ...options.headers
                        },
                        credentials: 'include'  // âœ… Send session cookie
                    });

                    if (!response.ok) {
                        const error = await response.json().catch(() => ({ detail: 'Unknown error' }));
                        throw new Error(error.detail || `HTTP ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    this.addLog(`API Error: ${error.message}`, 'error');
                    throw error;
                }
            },

            async loadData() {
                this.addLog('Loading data...');
                
                try {
                    const [workflowsData, agentsData, scriptsData] = await Promise.all([
                        this.apiCall('/workflows'),
                        this.apiCall('/agents'),
                        this.apiCall('/scripts')
                    ]);

                    this.workflows = workflowsData.workflows || workflowsData || [];
                    this.agents = agentsData.agents || agentsData || [];
                    this.scripts = scriptsData.scripts || scriptsData || [];

                    this.render();
                    this.addLog('Data loaded successfully', 'success');
                } catch (error) {
                    this.addLog('Failed to load data', 'error');
                }
            },

            // âœ… WORKFLOW EXECUTION - CORRECT FORMAT!
		async executeWorkflow(workflow) {
    const scriptId = workflow.script_id;
    
    if (!scriptId) {
        this.addLog('Workflow has no script', 'error');
        return;
    }
    
    // Call SCRIPT endpoint (which works!)
    const response = await fetch(`/api/scripts/${scriptId}/execute`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'include',
        body: JSON.stringify({})
    });
    
    const data = await response.json();
    this.addLog(`Script executed! ID: ${data.execution_id}`, 'success');
}

            async logout() {
                try {
                    await fetch('/api/auth/logout', {
                        method: 'POST',
                        credentials: 'include'
                    });
                    window.location.href = '/login.html';
                } catch (error) {
                    this.addLog('Logout failed', 'error');
                }
            },

            setTab(tab) {
                this.activeTab = tab;
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === tab);
                });
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.toggle('hidden', content.id !== `${tab}-tab`);
                });
            },

            addLog(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEl = document.getElementById('activity-log');
                
                const colors = {
                    error: 'text-red-600',
                    success: 'text-green-600',
                    warn: 'text-yellow-600',
                    info: 'text-gray-600'
                };

                const entry = document.createElement('div');
                entry.className = 'text-sm log-entry';
                entry.innerHTML = `
                    <span class="text-gray-400">[${timestamp}]</span>
                    <span class="${colors[type]}">${message}</span>
                `;

                if (logEl.children.length > 0 && logEl.children[0].textContent === 'No activity yet') {
                    logEl.innerHTML = '';
                }

                logEl.insertBefore(entry, logEl.firstChild);

                // Keep last 50 logs
                while (logEl.children.length > 50) {
                    logEl.removeChild(logEl.lastChild);
                }
            },

            getBadge(status) {
                const badges = {
                    'approved': 'badge-green',
                    'pending_approval': 'badge-yellow',
                    'running': 'badge-blue',
                    'completed': 'badge-green',
                    'failed': 'badge-red',
                    'online': 'badge-green',
                    'offline': 'badge-gray'
                };
                return `<span class="badge ${badges[status] || 'badge-gray'}">${status}</span>`;
            },

            render() {
                this.renderWorkflows();
                this.renderAgents();
                this.renderScripts();
            },

            renderWorkflows() {
                const container = document.getElementById('workflows-list');
                if (this.workflows.length === 0) {
                    container.innerHTML = '<div class="px-6 py-8 text-center text-gray-500">No workflows found</div>';
                    return;
                }

                container.innerHTML = this.workflows.map(w => `
                    <div class="px-6 py-4 hover:bg-gray-50 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <h3 class="text-base font-medium text-gray-900">${w.workflow_name}</h3>
                                <p class="text-sm text-gray-500 mt-1">${w.description || 'No description'}</p>
                                <div class="mt-2 flex items-center space-x-4 text-sm text-gray-500">
                                    <span>Target: ${w.target_agent}</span>
                                    <span>Type: ${w.workflow_type}</span>
                                    <span>Schedule: ${w.schedule}</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                ${this.getBadge(w.status)}
                                ${w.status === 'approved' ? `
				<button onclick='app.executeWorkflow(${JSON.stringify(w)})'>Execute</button>
                                        â–¶ Execute
                                    </button>
                                ` : ''}
                                ${this.executions[w.workflow_id] ? `
                                    <div class="text-xs text-gray-500">
                                        Exec #${this.executions[w.workflow_id].execution_id}
                                        ${this.getBadge(this.executions[w.workflow_id].status)}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            renderAgents() {
                const container = document.getElementById('agents-list');
                if (this.agents.length === 0) {
                    container.innerHTML = '<div class="px-6 py-8 text-center text-gray-500">No agents found</div>';
                    return;
                }

                container.innerHTML = this.agents.map(a => `
                    <div class="px-6 py-4 hover:bg-gray-50 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-base font-medium text-gray-900">${a.agent_name}</h3>
                                <p class="text-sm text-gray-500 mt-1">${a.host}:${a.port}</p>
                                <p class="text-xs text-gray-400 mt-1">Last seen: ${a.last_heartbeat || 'Never'}</p>
                            </div>
                            <div>${this.getBadge(a.status)}</div>
                        </div>
                    </div>
                `).join('');
            },

            renderScripts() {
                const container = document.getElementById('scripts-list');
                if (this.scripts.length === 0) {
                    container.innerHTML = '<div class="px-6 py-8 text-center text-gray-500">No scripts found</div>';
                    return;
                }

                container.innerHTML = this.scripts.map(s => `
                    <div class="px-6 py-4 hover:bg-gray-50 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-base font-medium text-gray-900">${s.script_name}</h3>
                                <p class="text-sm text-gray-500 mt-1">${s.description || 'No description'}</p>
                                <div class="mt-2 flex items-center space-x-4 text-sm text-gray-500">
                                    <span>Type: ${s.script_type}</span>
                                    <span>Timeout: ${s.timeout}s</span>
                                    <span>Created: ${new Date(s.created_at).toLocaleDateString()}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            init() {
                this.loadData();
                // Auto-refresh every 30 seconds
                setInterval(() => this.loadData(), 30000);
            }
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
